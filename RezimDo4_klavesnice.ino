#define pinVstup 2
#include "U8glib.h"
#include <Keypad.h>
#include <Wire.h>
#include <DS3231.h>

int xPos = 0;
DS3231 rtc;
RTCDateTime datumCas;
int textWidth = 0;
unsigned long casAktivace = 0;
unsigned long posledniVypis = 0;
bool stavSepnuto = false;
unsigned long now = millis();
const int dry = 563;
const int wet = 199;
String hladina ="";
//bool zobrazVlhkost = true;

const byte radky= 4;
const byte sloupce = 4;

char klavesy[radky][sloupce] = {
  {'1', '2', '3', 'A'},           //A - inkrementovat
  {'4', '5', '6', 'B'},           //B - dekrementovat
  {'7', '8', '9', 'C'},           //C - ok/ulozit
  {'*', '0', '#', 'D'}            //* - previous, # - next, D - zpět/neukládat/cancel
};

byte pinyRadku[radky] = {48, 46, 44, 42};
byte pinySloupcu[sloupce] = {40, 38, 36, 34};

// bitmapa UVODNI 128x64 uložená v PROGMEM
const uint8_t uvodni[] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xf7, 0x3b, 0xbc, 0x10, 0x41, 0xb7, 0x78, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xf7, 0x3b, 0x5f, 0x77, 0xdd, 0xb3, 0x77, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xfa, 0xb7, 0x5f, 0x77, 0xdd, 0xb5, 0x6f, 0xff, 0xff, 0xff, 0xfe, 0x7e, 0x79, 0xff, 0xff, 0xff, 
	0xfa, 0xd6, 0xef, 0x70, 0xc3, 0xb5, 0x6f, 0xff, 0xff, 0xff, 0xfe, 0x7e, 0x79, 0xff, 0xff, 0xff, 
	0xfa, 0xce, 0x0f, 0x77, 0xdd, 0xb6, 0x6e, 0xff, 0xff, 0xff, 0x98, 0x60, 0x00, 0x7f, 0xff, 0xff, 
	0xfd, 0xce, 0xef, 0x77, 0xdd, 0xb6, 0x66, 0xff, 0xff, 0xff, 0x98, 0x60, 0x00, 0x7f, 0xff, 0xff, 
	0xfd, 0xed, 0xf7, 0x70, 0x5e, 0xb7, 0x70, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x67, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x67, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe6, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe6, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 
	0xf8, 0x2e, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 
	0xfe, 0xee, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 
	0xfe, 0xee, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 
	0xfe, 0xe0, 0xc3, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 
	0xfe, 0xee, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 
	0xfe, 0xee, 0xdf, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x40, 0x00, 0x00, 0x00, 0x00, 0x1f, 0xff, 
	0xfe, 0xee, 0xc1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x73, 0xc0, 0x00, 0x00, 0x00, 0x1f, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x12, 0x40, 0x00, 0x00, 0x00, 0x1f, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x1e, 0x40, 0x00, 0x00, 0x00, 0x1f, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9e, 0x00, 0x00, 0x40, 0x00, 0x00, 0x00, 0x07, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x9e, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x00, 0x07, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x18, 0x00, 0x01, 0x00, 0x00, 0x00, 0x1f, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x18, 0x00, 0x01, 0xc0, 0x00, 0x00, 0x1f, 0xff, 
	0xf8, 0x71, 0xc1, 0x83, 0x08, 0x3f, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x40, 0x00, 0x00, 0x01, 0xff, 
	0xfb, 0xee, 0xdd, 0xbe, 0xfe, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x7f, 0x00, 0x00, 0x01, 0xff, 
	0xfb, 0xdf, 0x5d, 0xbe, 0x7e, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x07, 0xff, 
	0xf8, 0xdf, 0x43, 0x87, 0x1e, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x01, 0xfc, 0x00, 0x07, 0xff, 
	0xfb, 0xdf, 0x5d, 0xbf, 0xee, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x07, 0xff, 
	0xfb, 0xee, 0xdd, 0xbf, 0xee, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x00, 0x07, 0xc0, 0x07, 0xff, 
	0xfb, 0xf1, 0xde, 0x82, 0x1e, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x40, 0x1f, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x80, 0x00, 0x00, 0x00, 0x00, 0x7c, 0x1f, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x04, 0x7f, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf8, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7f, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x00, 0x00, 0x00, 0x01, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x00, 0x00, 0x00, 0x07, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x07, 0xff, 0xf8, 0x1f, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x07, 0xff, 0xf8, 0x1f, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xfe, 0x1f, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x1f, 0xff, 0xfe, 0x1f, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0x9f, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0x9f, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};

U8GLIB_SSD1306_128X64 u8g(U8G_I2C_OPT_NONE);   
U8GLIB_SSD1306_128X64 oled_1(U8G_I2C_OPT_NONE);   
Keypad klavesnice = Keypad(makeKeymap(klavesy), pinyRadku, pinySloupcu, radky, sloupce);

int aktualniRezim = 0;

String doplnNulu(int cislo) {
  if (cislo < 10) return "0" + String(cislo);
  else return String(cislo);
}

void vykresliKlavesnice(char klavesa){
  aktualniRezim = 4;
  static String zapsano = "?"; //prej mam dat static jeste pred to


  if (klavesa >= '0' && klavesa <= '9') {
    if(zapsano == "?") zapsano = "";
    int cislo  = zapsano.toInt();  // pokud je číslo
    if (zapsano.length() < 3 && cislo < 10) {            // max 3 číslice a jde zadat maximalne 99
      zapsano += klavesa;
      int cislo = zapsano.toInt();
    }
    else{                   
      zapsano = String(klavesa);
    }
  }
  else if (klavesa == 'D') {             // D = smazat vše
    zapsano = "?";
  }


  oled_1.firstPage();
  while(oled_1.nextPage()){
    oled_1.setFont(u8g_font_helvB14);

    textWidth = oled_1.getStrWidth(zapsano.c_str());
    xPos = (128 - textWidth)/2;
    oled_1.setPrintPos(xPos, 30);
    oled_1.print(zapsano + "%");

    oled_1.setFont(u8g_font_7x14);
    String text = "zalevat ?% <= " + String(zapsano);
    textWidth = oled_1.getStrWidth(text.c_str());
    xPos = (128 - textWidth) / 2;     
    oled_1.setPrintPos(xPos, 50);      
    oled_1.print(text);
    oled_1.drawLine(0,61,128,61);
  }
}

void vykresliDatumCas(RTCDateTime datumCas){
  aktualniRezim = 3;
  oled_1.firstPage();
  while(oled_1.nextPage()){
    oled_1.setFont(u8g_font_helvB14);
    String cas = String(doplnNulu(datumCas.hour)) + ":" + String(doplnNulu(datumCas.minute)) + ":" + String(doplnNulu(datumCas.second));
    textWidth = oled_1.getStrWidth(cas.c_str());
    int xPos = (128 - textWidth)/2;
    oled_1.setPrintPos(xPos, 30);
    oled_1.print(cas);

    String mesic = "";
    switch(datumCas.month){
      case 1: mesic = "leden"; break;
      case 2: mesic = "unor"; break;
      case 3: mesic = "brezen"; break;
      case 4: mesic = "duben"; break;
      case 5: mesic = "kveten"; break;
      case 6: mesic = "cerven"; break;
      case 7: mesic = "cervenec"; break;
      case 8: mesic = "srpen"; break;
      case 9: mesic = "zari"; break;
      case 10: mesic = "rijen"; break;
      case 11: mesic = "listopad"; break;
      case 12: mesic = "prosinec"; break;
    }

    oled_1.setFont(u8g_font_7x14);
    String datum = String(datumCas.day) + ". " + mesic + " " + String(datumCas.year);
    textWidth = oled_1.getStrWidth(datum.c_str());
    xPos = (128 - textWidth) / 2;     
    oled_1.setPrintPos(xPos, 50);      
    oled_1.print(datum);
    oled_1.drawLine(0,61,128,61);
  }
}


void vykresli()
{
  aktualniRezim = 0;
  u8g.firstPage();
  while(u8g.nextPage()){
    u8g.drawBitmapP(0, 0, 16, 64, uvodni); // 128/8 = 16 sloupců po 8 pixelech
  }
  
}

void vykresliVlhkost(int percentageHumidity)
{
  aktualniRezim = 1;
  oled_1.firstPage();
  while(oled_1.nextPage()){
    // nastavení fontu, odkaz v článku
    oled_1.setFont(u8g_font_helvB14);
    String velkeCislo = String(percentageHumidity) + "%";
    textWidth = oled_1.getStrWidth(velkeCislo.c_str()); // šířka textu v pixelech
    xPos = (128 - textWidth) / 2;  
    oled_1.setPrintPos(xPos, 30);      // vertikální pozice
    oled_1.print(velkeCislo);
    
    // změna fontu
    oled_1.setFont(u8g_font_7x14);
    String text = "vlhkost";
    textWidth = oled_1.getStrWidth(text.c_str());
    xPos = (128 - textWidth) / 2;  
    oled_1.setPrintPos(xPos, 50);      // pod číslem
    oled_1.print(text);
    // rovná čára (od souřadnic -> do souřadnic)
    oled_1.drawLine(0,61,128,61);
  }
}

void vykresliHladinu(bool stav){
  aktualniRezim = 2;
  oled_1.firstPage();
  if (stav == LOW) { 
    stavSepnuto = true;
    casAktivace = millis(); //now; - bylo predtim 
  } else { 
    stavSepnuto = false;
  }
  //posledniVypis = now; 
  while(oled_1.nextPage()){
    oled_1.setFont(u8g_font_helvB14);
    if(stavSepnuto == true){
      hladina = "ok!";
    }
    else{
      hladina = "nedostatek";
    }//lze optimalizovat
    textWidth = oled_1.getStrWidth(hladina.c_str()); 
    xPos = (128 - textWidth) / 2;  
    oled_1.setPrintPos(xPos, 30);
    oled_1.print(hladina);

    oled_1.setFont(u8g_font_7x14);
    String text = "hladina v nadrzi";
    textWidth = oled_1.getStrWidth(text.c_str());
    xPos = (128 - textWidth) / 2;  
    oled_1.setPrintPos(xPos, 50);      // pod číslem
    oled_1.print(text);
    // rovná čára (od souřadnic -> do souřadnic)
    oled_1.drawLine(0,61,128,61);
  }
}

void setup(void) {
  Serial.begin(9600);
  pinMode(pinVstup, INPUT_PULLUP);
  rtc.begin();
  if(rtc.isReady()){
    rtc.setDateTime(__DATE__, __TIME__);
  }
  
  
  
  
  
}

void loop(void) {
  datumCas = rtc.getDateTime();
  now = millis();
  char klavesa = klavesnice.getKey();
  int sensorVal = analogRead(A0);  
  int percentageHumidity = map(sensorVal, wet, dry, 100, 0);
  //nevim kam dat
  bool stav = digitalRead(pinVstup); 
  
  //delay(5000);

  
  
  // kontrola, zda je čas na nový výpis (každou sekundu)
  /*if (now - posledniVypis >= 5000) {
    posledniVypis = now;
    if(zobrazVlhkost){
      vykresliVlhkost(percentageHumidity);
    }
    else{
      vykresliHladinu(stav);
    }
    zobrazVlhkost = !zobrazVlhkost;
  }*/
  //vykresliHladinu(stav);
  if(klavesa == '*'){
    aktualniRezim = aktualniRezim - 1;
    if(aktualniRezim < 0){
      aktualniRezim = 4;
    }
  } 
  else if(klavesa == '#'){
    aktualniRezim = aktualniRezim + 1;
    if(aktualniRezim > 4){
      aktualniRezim = 0;
    }
  } 

  if(aktualniRezim == 4){
    vykresliKlavesnice(klavesa);
  }
  if(now - posledniVypis >= 1000){
    posledniVypis = now;
    switch(aktualniRezim){
      case 0: vykresli(); break;
      case 1: vykresliVlhkost(percentageHumidity); break;
      case 2: vykresliHladinu(stav); break;
      case 3: vykresliDatumCas(datumCas); break;
    }
  }
  
  
}